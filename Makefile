# Generated By: Cursor (Claude Sonnet 4)
# Makefile for VM Workstation Setup Ansible Playbook

.DEFAULT_GOAL := help
.PHONY: help pip-install-dev collections lint lint-python lint-ansible syntax run dry-run clean check-deps configure show-config info version

# Variables
ANSIBLE_DIR := ansible
PLAYBOOK := $(ANSIBLE_DIR)/site.yml
INVENTORY := localhost,
CONNECTION := local
TAGS ?= 
LIMIT ?=

# Python virtual environment
VENV_DIR ?= .venv
PYTHON := $(VENV_DIR)/bin/python
PIP := $(VENV_DIR)/bin/pip
UV := $(VENV_DIR)/bin/uv

# Project-local Ansible collections location
COLLECTIONS_DIR := $(CURDIR)/collections

# Export common environment for all recipes
export PATH := $(CURDIR)/$(VENV_DIR)/bin:$(PATH)
export ANSIBLE_CONFIG := $(CURDIR)/$(ANSIBLE_DIR)/ansible.cfg
export ANSIBLE_COLLECTIONS_PATH := $(COLLECTIONS_DIR)

help: ## Display this help message
	@echo "VM Workstation Setup - Ansible Playbook"
	@echo "========================================"
	@echo ""
	@echo "Available targets:"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

configure: pip-install-dev ## Interactive configuration picker
	@echo "Running configuration picker..."
	@$(PYTHON) configure.py

show-config: pip-install-dev ## Show current configuration
	@echo "Current configuration:"
	@$(PYTHON) configure.py --show

run: syntax collections ## Run setup using current configuration selections
	@echo "Running setup with current configuration..."
	@$(PYTHON) -c "import yaml; config=yaml.safe_load(open('config.yml')); tags=[k.replace('_', '-') for k,v in config.items() if v and k not in ['component_descriptions', 'default_selections']]; print('ansible-playbook -i $(INVENTORY) -c $(CONNECTION) $(PLAYBOOK) --ask-become-pass ' + ('--tags ' + ','.join(tags) if tags else ''))" | bash

.PHONY: venv
venv: ## Create Python virtual environment
	@if [ ! -d "$(VENV_DIR)" ]; then \
		printf "$(BLUE)Creating virtual environment...$(RESET)\n"; \
		python3 -m venv $(VENV_DIR); \
		printf "$(GREEN)✅ Virtual environment created$(RESET)\n"; \
	fi

.PHONY: uv # Install uv
uv: venv
	@if [ ! -f "$(VENV_DIR)/bin/uv" ]; then \
		printf "$(BLUE)Installing uv...$(RESET)\n"; \
		$(PYTHON) -m ensurepip --upgrade; \
		$(PYTHON) -m pip install uv; \
		printf "$(GREEN)✅ uv installed$(RESET)\n"; \
	fi

pip-install-dev: uv ## Install development/test dependencies (e.g., ansible-lint) in venv
	@$(UV) pip install --upgrade pip >/dev/null
	@echo "Installing development/test dependencies..."
	@$(UV) pip install -r requirements-dev.txt
	@echo "✅ Dev/test dependencies installed in $(VENV_DIR)"

lint: pip-install-dev lint-python lint-ansible ## Run all linting
	@echo "✅ All linting passed"

lint-python: pip-install-dev ## Lint Python files with ruff
	@echo "Running ruff on Python files..."
	@ruff check configure.py
	@echo "✅ Python lint passed"

lint-ansible: pip-install-dev ## Run ansible-lint validation
	@echo "Running ansible-lint validation..."
	@echo "Installing collections locally..."
	@ansible-galaxy collection install -r $(ANSIBLE_DIR)/requirements.yml -p $(COLLECTIONS_DIR)
	@echo "Debug: Files to be scanned:"
	@find $(ANSIBLE_DIR) -name "*.yml" -o -name "*.yaml" | grep -v gpg/ | head -10
	@echo "Running ansible-lint (matching CI behavior)..."
	@ansible-lint $(ANSIBLE_DIR)
	@echo "✅ Ansible lint passed"

collections: pip-install-dev ## Install required Ansible collections locally
	@echo "Installing required Ansible collections to $(COLLECTIONS_DIR)..."
	@ansible-galaxy collection install -r $(ANSIBLE_DIR)/requirements.yml -p $(COLLECTIONS_DIR)
	@echo "✅ Collections installed"

syntax: pip-install-dev collections ## Validate playbook syntax
	@echo "Checking playbook syntax..."
	@ansible-lint --version >/dev/null || true
	@ansible-playbook --syntax-check -i $(INVENTORY) -c $(CONNECTION) $(PLAYBOOK)
	@echo "✅ Syntax validation passed"

dry-run: check-deps collections ## Run playbook in check mode (dry-run)
	@echo "Running playbook in check mode (dry-run)..."
	@ansible-playbook --check -i $(INVENTORY) -c $(CONNECTION) $(PLAYBOOK) \
		--ask-become-pass \
		$(if $(TAGS),--tags $(TAGS),) \
		$(if $(LIMIT),--limit $(LIMIT),)
	@echo "✅ Dry-run completed"

check-deps: ## Verify all prerequisites are met
	@echo "Checking for required dependencies..."
	@command -v ansible >/dev/null 2>&1 || { \
		echo "❌ ansible not found. Please install: sudo dnf install ansible"; \
		exit 1; \
	}
	@command -v ansible-lint >/dev/null 2>&1 || { \
		echo "❌ ansible-lint not found. Please run: make pip-install-dev"; \
		exit 1; \
	}
	@command -v python3 >/dev/null 2>&1 || { \
		echo "❌ python3 not found. Please install: sudo dnf install python3"; \
		exit 1; \
	}
	@$(PYTHON) -c "import yaml" 2>/dev/null || { \
		echo "❌ PyYAML not available in venv. Ensure pip-install-dev installed: make pip-install-dev"; \
		exit 1; \
	}
	@echo "✅ All dependencies found"
	@echo "Checking system readiness..."
	@ansible-playbook --syntax-check -i $(INVENTORY) -c $(CONNECTION) $(PLAYBOOK) >/dev/null 2>&1 || { \
		echo "❌ Playbook syntax check failed"; \
		exit 1; \
	}
	@echo "✅ System ready for workstation setup"

info: ## Show playbook details
	@echo "Playbook Information:"
	@echo "===================="
	@echo "Playbook: $(PLAYBOOK)"
	@echo "Inventory: $(INVENTORY)"
	@echo "Connection: $(CONNECTION)"
	@echo ""
	@echo "Available tags:"
	@cd $(ANSIBLE_DIR) && grep -h "tags:" roles/*/tasks/main.yml site.yml | sort -u || echo "  (no specific tags found)"
	@echo ""
	@echo "Roles:"
	@cd $(ANSIBLE_DIR) && ls -1 roles/ | sed 's/^/  - /'

clean: ## Remove temporary and backup files
	@echo "Cleaning temporary files..."
	# Python caches
	@find . -name "*.pyc" -delete 2>/dev/null || true
	@find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	# Ansible retry/logs and ansible temp dirs
	@find . -name "*.retry" -delete 2>/dev/null || true
	@rm -f $(ANSIBLE_DIR)/ansible.log 2>/dev/null || true
	@rm -rf .ansible 2>/dev/null || true
	# Local collections cache
	@rm -rf collections 2>/dev/null || true
	# Python virtual environment
	@rm -rf $(VENV_DIR) 2>/dev/null || true
	# Misc ignored artifacts
	@rm -rf dist build *.egg-info/ docs/_build site .pytest_cache .coverage htmlcov .tox local scratch logs 2>/dev/null || true
	@echo "✅ Cleanup completed"

version: ## Display Ansible version
	@ansible --version
	@echo ""
	@ansible-lint --version 2>/dev/null || echo "ansible-lint not installed"
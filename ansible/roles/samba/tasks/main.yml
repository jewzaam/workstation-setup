---
# Generated By: Cursor (Claude Sonnet 4)
# Samba file sharing tasks

- name: Install Samba packages
  ansible.builtin.dnf:
    name:
      - samba
      - samba-client
      - samba-common
    state: present
  become: true

- name: Create shared directory
  ansible.builtin.file:
    path: "{{ samba_share_path }}"
    state: directory
    mode: "0755"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"

- name: Configure Samba global settings
  ansible.builtin.template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    mode: "0644"
    owner: root
    group: root
  become: true

- name: Validate Samba configuration
  ansible.builtin.command: testparm -s
  become: true
  register: samba_config_validation
  failed_when: samba_config_validation.rc != 0
  changed_when: false

- name: Restart Samba service after configuration
  ansible.builtin.systemd:
    name: smb
    state: restarted
  become: true
  when: samba_config_validation.rc == 0

# Create Samba user account using pdbedit (Samba 4.x method)
- name: Create Samba user account
  ansible.builtin.command: "pdbedit -a {{ user_name }} -t"
  become: true
  register: samba_user_result
  failed_when: false
  changed_when: samba_user_result.rc == 0

# Note: User is created with no password. You'll need to set a password manually:
# sudo smbpasswd jewzaam
# This creates a separate Samba password for network access
# The -t flag creates a machine trust account which is more appropriate for file sharing

- name: Enable Samba services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  become: true
  loop:
    - smb
    - nmb

- name: Configure firewall for Samba
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  become: true
  loop:
    - "139/tcp"
    - "445/tcp"
  notify: Reload Firewalld

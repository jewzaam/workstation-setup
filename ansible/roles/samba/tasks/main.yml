---
# Generated By: Cursor (Claude Sonnet 4)
# Samba file sharing tasks

- name: Install Samba packages
  ansible.builtin.dnf:
    name:
      - samba
      - samba-client
      - samba-common
    state: present
  become: true

- name: Create shared directory
  ansible.builtin.file:
    path: "{{ samba_share_path }}"
    state: directory
    mode: "0755"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"

- name: Set SELinux context for Samba share
  ansible.builtin.command: >
    semanage fcontext -a -t samba_share_t "{{ samba_share_path }}(/.*)?"
  become: true
  register: samba_selinux_context_result
  failed_when: false
  changed_when: samba_selinux_context_result.rc == 0

- name: Apply SELinux context
  ansible.builtin.command: restorecon -Rv "{{ samba_share_path }}"
  become: true
  changed_when: true

- name: Configure Samba global settings
  ansible.builtin.template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    mode: "0644"
    owner: root
    group: root
  become: true

- name: Validate Samba configuration
  ansible.builtin.command: testparm -s
  become: true
  register: samba_config_validation
  failed_when: samba_config_validation.rc != 0
  changed_when: false

- name: Restart Samba service after configuration
  ansible.builtin.systemd:
    name: smb
    state: restarted
  become: true
  when: samba_config_validation.rc == 0

# Check if Samba user exists
- name: Check if Samba user exists
  ansible.builtin.command: "pdbedit -L"
  become: true
  register: samba_user_list
  failed_when: false
  changed_when: false

- name: Set user existence fact
  ansible.builtin.set_fact:
    samba_user_exists: "{{ user_name in samba_user_list.stdout }}"

# Create Samba user account only if it doesn't exist
- name: Create Samba user account
  ansible.builtin.shell: >
    /usr/bin/smbpasswd -a {{ user_name }} <<< '{{ samba_initial_password }}'
  become: true
  register: samba_user_result
  failed_when: samba_user_result.rc != 0
  changed_when: samba_user_result.rc == 0
  when: not samba_user_exists

# Note: User is created with initial password from config.
# You can change it later using:
# sudo smbpasswd username
# This creates a separate Samba password for network access

- name: Enable Samba services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  become: true
  loop:
    - smb
    - nmb

- name: Configure firewall for Samba
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  become: true
  loop:
    - "139/tcp"
    - "445/tcp"
  notify: Reload Firewalld

---
# Generated By: Cursor (Claude Sonnet 4)
# Cursor installation via AppImage

- name: Check if Cursor is already installed
  ansible.builtin.stat:
    path: "{{ cursor_install_dir }}/cursor.AppImage"
  register: cursor_installed

- name: Create Cursor installation directory
  ansible.builtin.file:
    path: "{{ cursor_install_dir }}"
    state: directory
    mode: "0755"
  become: true
  when: not cursor_installed.stat.exists

- name: Get Cursor download URL from API
  ansible.builtin.uri:
    url: "{{ cursor_api_url }}"
    method: GET
    return_content: true
  register: cursor_api_response
  when: not cursor_installed.stat.exists

- name: Download Cursor AppImage
  ansible.builtin.get_url:
    url: "{{ cursor_api_response.json.downloadUrl }}"
    dest: "{{ cursor_install_dir }}/cursor.AppImage"
    mode: "0755"
    timeout: 300
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"
  become: true
  when: not cursor_installed.stat.exists
  register: cursor_download

- name: Download Cursor icon
  ansible.builtin.get_url:
    url: "{{ cursor_icon_url }}"
    dest: "{{ cursor_icon_file }}"
    mode: "0644"
    timeout: 60
  become: true
  when: not cursor_installed.stat.exists

- name: Create Cursor desktop entry
  ansible.builtin.copy:
    content: |
      [Desktop Entry]
      Name=Cursor
      Comment=AI-powered code editor
      Exec={{ cursor_install_dir }}/cursor.AppImage %F
      Icon={{ cursor_icon_file }}
      Terminal=false
      Type=Application
      Categories=Development;TextEditor;
      MimeType=text/plain;inode/directory;
      StartupWMClass=cursor
    dest: "{{ cursor_desktop_file }}"
    mode: "0644"
  become: true
  when: cursor_download is succeeded

- name: Create command line symlink for Cursor
  ansible.builtin.file:
    src: "{{ cursor_install_dir }}/cursor.AppImage"
    dest: "/usr/local/bin/cursor"
    state: link
  become: true
  when: cursor_download is succeeded

- name: Update desktop database
  ansible.builtin.command: update-desktop-database /usr/share/applications/
  become: true
  when: cursor_download is succeeded
  changed_when: true

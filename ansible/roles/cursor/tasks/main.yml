---
# Generated By: Cursor (Claude Sonnet 4)
# Cursor installation via AppImage

- name: Check if Cursor is already installed
  ansible.builtin.stat:
    path: "{{ cursor_install_dir }}/cursor.AppImage"
  register: cursor_installed

- name: Create Cursor installation directory
  ansible.builtin.file:
    path: "{{ cursor_install_dir }}"
    state: directory
    mode: "0755"
  become: true
  when: not cursor_installed.stat.exists

- name: Get Cursor download URL from API
  ansible.builtin.uri:
    url: "{{ cursor_api_url }}"
    method: GET
    return_content: true
  register: cursor_api_response
  when: not cursor_installed.stat.exists

- name: Download Cursor AppImage
  ansible.builtin.get_url:
    url: "{{ cursor_api_response.json.downloadUrl }}"
    dest: "{{ cursor_install_dir }}/cursor.AppImage"
    mode: "0755"
    timeout: 300
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"
  become: true
  when: not cursor_installed.stat.exists
  register: cursor_download

- name: Download Cursor icon
  ansible.builtin.get_url:
    url: "{{ cursor_icon_url }}"
    dest: "{{ cursor_icon_file }}"
    mode: "0644"
    timeout: 60
  become: true
  when: not cursor_installed.stat.exists

- name: Create Cursor desktop entry
  ansible.builtin.copy:
    content: |
      [Desktop Entry]
      Name=Cursor
      Comment=AI-powered code editor
      Exec={{ cursor_install_dir }}/cursor.AppImage %F
      Icon={{ cursor_icon_file }}
      Terminal=false
      Type=Application
      Categories=Development;TextEditor;
      MimeType=text/plain;inode/directory;
      StartupWMClass=cursor
    dest: "{{ cursor_desktop_file }}"
    mode: "0644"
  become: true
  when: cursor_download is succeeded

- name: Create command line symlink for Cursor
  ansible.builtin.file:
    src: "{{ cursor_install_dir }}/cursor.AppImage"
    dest: "/usr/local/bin/cursor"
    state: link
  become: true
  when: cursor_download is succeeded

- name: Update desktop database
  ansible.builtin.command: update-desktop-database /usr/share/applications/
  become: true
  when: cursor_download is succeeded
  changed_when: true

# Cursor configuration for performance optimization
- name: Ensure jq is installed for JSON manipulation
  ansible.builtin.package:
    name: jq
    state: present
  become: true

- name: Create Cursor config directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ cursor_config_dir }}"
    state: directory
    mode: "0755"

- name: Check if Cursor settings file exists
  ansible.builtin.stat:
    path: "{{ cursor_settings_file }}"
  register: cursor_settings_file_stat

- name: Create empty settings file if it doesn't exist
  ansible.builtin.copy:
    content: "{}"
    dest: "{{ cursor_settings_file }}"
    mode: "0644"
  when: not cursor_settings_file_stat.stat.exists

- name: Create temporary directory for cursor configuration
  ansible.builtin.tempfile:
    state: directory
    suffix: cursor_config
  register: cursor_temp_dir

- name: Create performance settings template
  ansible.builtin.copy:
    content: |
      {
        "files.watcherExclude": {
          "**/__pycache__/**": true,
          "**/venv/**": true,
          "**/.venv/**": true,
          "**/node_modules/**": true,
          "**/htmlcov/**": true,
          "**/*.pyc": true,
          "**/.pytest_cache/**": true,
          "**/coverage.xml": true,
          "**/.coverage": true,
          "**/dist/**": true,
          "**/build/**": true,
          "**/*.egg-info/**": true
        },
        "search.exclude": {
          "**/__pycache__": true,
          "**/venv": true,
          "**/.venv": true,
          "**/node_modules": true,
          "**/htmlcov": true,
          "**/.pytest_cache": true,
          "**/dist": true,
          "**/build": true,
          "**/*.egg-info": true
        },
        "files.exclude": {
          "**/__pycache__": true,
          "**/*.pyc": true
        }
      }
    dest: "{{ cursor_temp_dir.path }}/cursor_performance_settings.json"
    mode: "0644"

- name: Merge performance settings with existing Cursor settings
  ansible.builtin.shell: |
    temp_settings="{{ cursor_temp_dir.path }}/cursor_performance_settings.json"
    temp_merged="{{ cursor_temp_dir.path }}/merged_settings.json"
    if jq -s '.[0] * .[1]' "{{ cursor_settings_file }}" "$temp_settings" > "$temp_merged"; then
      mv "$temp_merged" "{{ cursor_settings_file }}"
      echo "Successfully merged Cursor performance settings"
    else
      echo "Failed to merge JSON settings" >&2
      exit 1
    fi
  args:
    executable: /bin/bash
  register: cursor_merge_result
  failed_when: cursor_merge_result.rc != 0
  changed_when: true

- name: Clean up temporary directory
  ansible.builtin.file:
    path: "{{ cursor_temp_dir.path }}"
    state: absent

---
# Generated By: Cursor (Claude Sonnet 4)
# Claude Code installation and configuration

- name: Define Claude binary path
  ansible.builtin.set_fact:
    claude_code_user_bin: "{{ user_home }}/.local/bin/claude"

- name: Check if Claude Code is already installed in user bin
  ansible.builtin.stat:
    path: "{{ claude_code_user_bin }}"
  register: claude_code_user_bin_stat

- name: Check if Claude Code is installed globally
  ansible.builtin.stat:
    path: "/usr/local/bin/claude"
  register: claude_code_global_bin_stat

- name: Set installation status fact
  ansible.builtin.set_fact:
    claude_code_installed: "{{ claude_code_user_bin_stat.stat.exists or claude_code_global_bin_stat.stat.exists }}"

- name: Define Claude CLI path to use
  ansible.builtin.set_fact:
    claude_code_bin: "{{ claude_code_user_bin_stat.stat.exists | ternary(claude_code_user_bin, '/usr/local/bin/claude') }}"

- name: Compute effective Claude Code version
  ansible.builtin.set_fact:
    claude_code_version_effective: "{{ (claude_code_version | default('stable')) | lower }}"

- name: Install Claude Code via native installer
  ansible.builtin.shell: |
    set -euo pipefail
    curl -fsSL https://claude.ai/install.sh | bash {{ '-s ' ~ claude_code_version_effective if claude_code_version_effective not in ['', 'stable'] else '' }}
  args:
    executable: /usr/bin/bash
    creates: "{{ claude_code_user_bin }}"
  environment:
    DISABLE_AUTOUPDATER: "{{ '1' if not claude_code_auto_updates else '' }}"
  when:
    - not claude_code_installed
    - claude_code_install_method | lower == 'native'
  changed_when: true
  become: false

- name: Re-check Claude Code user binary after install
  ansible.builtin.stat:
    path: "{{ claude_code_user_bin }}"
  register: claude_code_user_bin_stat

- name: Re-check Claude Code global binary after install
  ansible.builtin.stat:
    path: "/usr/local/bin/claude"
  register: claude_code_global_bin_stat

- name: Refresh installation status fact after install
  ansible.builtin.set_fact:
    claude_code_installed: "{{ claude_code_user_bin_stat.stat.exists or claude_code_global_bin_stat.stat.exists }}"

- name: Refresh Claude CLI path to use after install
  ansible.builtin.set_fact:
    claude_code_bin: "{{ claude_code_user_bin_stat.stat.exists | ternary(claude_code_user_bin, '/usr/local/bin/claude') }}"

- name: Read current autoUpdates setting (best effort)
  ansible.builtin.command:
    cmd: "{{ claude_code_bin }} config get autoUpdates --global"
  when: claude_code_installed
  register: claude_code_auto_updates_get
  changed_when: false
  failed_when: false
  become: false

- name: Ensure auto updates configuration matches desired value
  ansible.builtin.command:
    cmd: "{{ claude_code_bin }} config set autoUpdates {{ 'true' if claude_code_auto_updates else 'false' }} --global"
  when:
    - claude_code_installed
    - (claude_code_auto_updates_get.stdout | default('') | trim | lower) != (claude_code_auto_updates | ternary('true','false'))
  changed_when: true
  become: false

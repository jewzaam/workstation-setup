---
# Generated By: Cursor (Claude Sonnet 4)
# NoMachine installation and configuration

- name: Install NoMachine dependencies
  ansible.builtin.dnf:
    name: "{{ nomachine_packages }}"
    state: present
  become: true

- name: Create NoMachine download directory
  ansible.builtin.file:
    path: "{{ nomachine_download_dir }}"
    state: directory
    mode: "0755"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"

- name: Check if NoMachine is already installed
  ansible.builtin.stat:
    path: /usr/NX/bin/nxserver
  register: nomachine_installed

- name: Download NoMachine RPM
  ansible.builtin.get_url:
    url: "{{ nomachine_download_url }}"
    dest: "{{ nomachine_download_dir }}/{{ nomachine_rpm_filename }}"
    mode: "0644"
    timeout: 300
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"
  when: not nomachine_installed.stat.exists
  register: nomachine_download

- name: Install NoMachine RPM
  ansible.builtin.dnf:
    name: "{{ nomachine_download_dir }}/{{ nomachine_rpm_filename }}"
    state: present
  become: true
  when: nomachine_download is succeeded
  register: nomachine_install

- name: Get NoMachine service status
  ansible.builtin.systemd:
    name: nxserver
  register: nomachine_status
  when: nomachine_install is succeeded

- name: Display NoMachine installation summary
  ansible.builtin.debug:
    msg: |
      NoMachine Installation Complete:
      ✓ Dependencies installed: {{ nomachine_packages | join(', ') }}
      ✓ RPM downloaded: {{ nomachine_rpm_filename }}
      ✓ NoMachine installed: {{ 'YES' if nomachine_install is succeeded else 'NO' }}
      ✓ Service status: {{ nomachine_status.status.ActiveState if nomachine_status is defined else 'UNKNOWN' }}

      NoMachine Information:
      - Version: {{ nomachine_version }}
      - Architecture: {{ nomachine_arch }}
      - Install method: {{ nomachine_install_method }}
      - Download URL: {{ nomachine_download_url }}
      - Service: nxserver
      - Default port: 4000

      Access Information:
      - Connect to: {{ ansible_default_ipv4.address }}:4000
      - Or use: nxclient (if installed on client)
  when: nomachine_install is succeeded

- name: NoMachine already installed notice
  ansible.builtin.debug:
    msg: |
      NoMachine already installed:
      - Service: nxserver
      - Default port: 4000
      - Connect to: {{ ansible_default_ipv4.address }}:4000
  when: nomachine_installed.stat.exists

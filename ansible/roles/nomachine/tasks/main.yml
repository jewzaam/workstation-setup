---
# Generated By: Cursor (Claude Sonnet 4)
# NoMachine installation and configuration

- name: Install NoMachine dependencies
  ansible.builtin.dnf:
    name: "{{ nomachine_packages }}"
    state: present
  become: true

- name: Check if NoMachine is already installed
  ansible.builtin.stat:
    path: /usr/NX/bin/nxserver
  register: nomachine_installed

- name: Create NoMachine download directory
  ansible.builtin.file:
    path: "{{ nomachine_download_dir }}"
    state: directory
    mode: "0755"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
  when: not nomachine_installed.stat.exists

- name: Download NoMachine RPM
  ansible.builtin.get_url:
    url: "{{ nomachine_download_url }}"
    dest: "{{ nomachine_download_dir }}/{{ nomachine_rpm_filename }}"
    mode: "0644"
    timeout: 300
    headers:
      User-Agent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"
  when: not nomachine_installed.stat.exists
  register: nomachine_download

- name: Install NoMachine RPM
  ansible.builtin.dnf:
    name: "{{ nomachine_download_dir }}/{{ nomachine_rpm_filename }}"
    state: present
    disable_gpg_check: true
  become: true
  when: nomachine_download is succeeded
  register: nomachine_install

- name: Ensure NoMachine service is enabled and started
  ansible.builtin.systemd:
    name: nxserver
    enabled: true
    state: started
  become: true
  when: nomachine_installed.stat.exists or (nomachine_install is defined and nomachine_install is succeeded)

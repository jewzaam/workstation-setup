---
# Generated By: Cursor (Claude Sonnet 4)
# Dotfiles deployment tasks

- name: Deploy dotfiles to user home directory
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ user_home }}/{{ item.dest }}"
    mode: "{{ item.mode }}"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    backup: true
  loop: "{{ dotfiles }}"
  register: dotfiles_deployed

- name: Create backup directory info
  ansible.builtin.debug:
    msg: |
      Dotfiles deployed successfully!
      Original files backed up with .ansible-backup~ extension
      Files deployed:
      {% for file in dotfiles %}
      - {{ file.dest }}
      {% endfor %}

- name: Verify bashrc_prompt dependency
  ansible.builtin.lineinfile:
    path: "{{ user_home }}/.bashrc"
    line: ". ~/.bashrc_prompt"
    state: present
  check_mode: true
  register: bashrc_prompt_check

- name: Confirm bashrc_prompt sourcing
  ansible.builtin.debug:
    msg: "✓ .bashrc correctly sources .bashrc_prompt"
  when: not bashrc_prompt_check.changed

- name: Configure git settings (preserves existing user config)
  community.general.git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop: "{{ git_config }}"

- name: Verify meld configuration in gitconfig
  ansible.builtin.lineinfile:
    path: "{{ user_home }}/.gitconfig"
    line: "    tool = meld"
    state: present
  check_mode: true
  register: meld_config_check

- name: Confirm meld gitconfig setup
  ansible.builtin.debug:
    msg: "✓ .gitconfig correctly configured for meld diff tool"
  when: not meld_config_check.changed

- name: Set ownership on all dotfiles
  ansible.builtin.file:
    path: "{{ user_home }}/{{ item.dest }}"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
  loop: "{{ dotfiles }}"

- name: Validate deployed files exist
  ansible.builtin.stat:
    path: "{{ user_home }}/{{ item.dest }}"
  loop: "{{ dotfiles }}"
  register: dotfile_validation

- name: Report deployment status
  ansible.builtin.debug:
    msg: |
      Dotfiles deployment summary:
      {% for result in dotfile_validation.results %}
      - {{ result.item.dest }}: {{ 'EXISTS' if result.stat.exists else 'MISSING' }}
      {% endfor %}
      Git configuration: CONFIGURED via git_config module (preserves user settings)
